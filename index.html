<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FODDACITRON /// SYSTEM_OVERRIDE</title>
    <style>
        /* --- IMPORTS & VARS --- */
        @import url('https://fonts.googleapis.com/css2?family=Archivo+Black&family=VT323&family=Space+Mono:ital,wght@0,400;0,700;1,400&display=swap');
        :root { --bg-color: #FBFF00; --accent-pink: #FF0055; --accent-green: #00FF33; --accent-purple: #9D00FF; --border-black: 3px solid #000000; --shadow-hard: 8px 8px 0px 0px #000000; }
        * { box-sizing: border-box; }
        body { background-color: var(--bg-color); font-family: 'Space Mono', monospace; margin: 0; padding: 0; color: black; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* --- CRT EFFECT --- */
        .crt::before { content: " "; display: block; position: absolute; top: 0; left: 0; bottom: 0; right: 0; background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06)); z-index: 999; background-size: 100% 2px, 3px 100%; pointer-events: none; }
        @keyframes shake { 0% { transform: translate(1px, 1px) rotate(0deg); } 10% { transform: translate(-1px, -2px) rotate(-1deg); } 20% { transform: translate(-3px, 0px) rotate(1deg); } 30% { transform: translate(3px, 2px) rotate(0deg); } 40% { transform: translate(1px, -1px) rotate(1deg); } 50% { transform: translate(-1px, 2px) rotate(-1deg); } 60% { transform: translate(-3px, 1px) rotate(0deg); } 70% { transform: translate(3px, 1px) rotate(-1deg); } 80% { transform: translate(-1px, -1px) rotate(1deg); } 90% { transform: translate(1px, 2px) rotate(0deg); } 100% { transform: translate(1px, -2px) rotate(-1deg); } }
        .shake-active { animation: shake 0.5s; animation-iteration-count: infinite; }
        .grid-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: linear-gradient(black 1px, transparent 1px), linear-gradient(90deg, black 1px, transparent 1px); background-size: 40px 40px; opacity: 0.05; z-index: -1; pointer-events: none; }
        .sticker { position: absolute; pointer-events: none; opacity: 0.1; z-index: -1; font-family: 'Archivo Black'; font-size: 5rem; color: black; transform: rotate(-15deg); }

        /* --- HEADER --- */
        header { background: black; color: white; padding: 12px 0; border-bottom: var(--border-black); white-space: nowrap; overflow: hidden; flex-shrink: 0; border-top: 5px solid var(--accent-pink); }
        .marquee { display: inline-block; animation: scroll-left 20s linear infinite; font-family: 'Archivo Black', sans-serif; font-size: 1.2rem; text-transform: uppercase; color: var(--bg-color); }
        @keyframes scroll-left { from { transform: translateX(100%); } to { transform: translateX(-100%); } }

        /* --- LAYOUT --- */
        main { flex: 1; display: flex; padding: 20px; gap: 20px; max-width: 1200px; margin: 0 auto; width: 100%; height: 100%; overflow: hidden; }
        
        .sidebar { width: 300px; display: flex; flex-direction: column; flex-shrink: 0; border: var(--border-black); box-shadow: var(--shadow-hard); background: white; transition: transform 0.2s; }
        .sidebar:hover { transform: translate(-2px, -2px); box-shadow: 10px 10px 0 black; }
        .logo-area { background: var(--bg-color); padding: 20px; border-bottom: var(--border-black); display: flex; justify-content: center; align-items: center; position: relative; overflow: hidden; }
        .logo-area::after { content: "JF"; position: absolute; top: -10px; right: -10px; font-family: 'Archivo Black'; font-size: 80px; color: rgba(0,0,0,0.05); transform: rotate(20deg); pointer-events: none; }
        .channel-logo { max-width: 100%; height: auto; max-height: 100px; filter: drop-shadow(4px 4px 0 black); transition: transform 0.2s; }
        .channel-logo:hover { transform: scale(1.1) rotate(-5deg); cursor: pointer; }

        .history-panel { flex: 1; display: flex; flex-direction: column; overflow: hidden; background: white; }
        .history-header { background: black; color: white; padding: 10px; font-family: 'Archivo Black'; font-size: 0.8rem; text-transform: uppercase; display: flex; justify-content: space-between; align-items: center; }
        .history-list { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; scrollbar-width: thin; scrollbar-color: black #eee; }
        .history-item { border: 2px solid black; font-size: 0.8rem; cursor: pointer; background: #eee; font-family: 'VT323', monospace; font-size: 1.2rem; display: flex; justify-content: space-between; align-items: center; padding: 8px 8px 8px 12px; }
        .history-item:hover { background: var(--accent-green); box-shadow: 3px 3px 0 0 black; }
        .history-item.active { background: var(--accent-pink); color: white; transform: translate(-2px, -2px); box-shadow: 3px 3px 0 0 black;}
        .history-text { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1; }
        .delete-btn { font-family: 'Space Mono'; font-weight: bold; font-size: 0.9rem; color: var(--accent-pink); margin-left: 8px; padding: 2px 6px; border: 1px solid transparent; transition: all 0.1s; }
        .history-item.active .delete-btn { color: white; border-color: white; }
        .delete-btn:hover { background: red; color: white !important; border: 1px solid black; box-shadow: 2px 2px 0 black; transform: scale(1.1); }
        .new-chat-btn { background: var(--bg-color); border-top: var(--border-black); padding: 20px; font-weight: bold; cursor: pointer; text-transform: uppercase; text-align: center; font-family: 'Archivo Black'; transition: background 0.2s; }
        .new-chat-btn:hover { background: #fffbe6; color: var(--accent-pink); }

        /* --- CHAT AREA --- */
        .chat-interface { flex: 1; background: white; border: var(--border-black); box-shadow: var(--shadow-hard); display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .chat-header { background: var(--accent-pink); border-bottom: var(--border-black); padding: 10px 15px; font-family: 'Archivo Black'; display: flex; justify-content: space-between; align-items: center; color: white; text-shadow: 2px 2px 0 black; }
        .messages-area { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; gap: 40px; background-color: #fafafa; background-image: radial-gradient(#000000 1px, transparent 1px); background-size: 20px 20px; }
        .message { max-width: 85%; padding: 15px; border: var(--border-black); font-size: 1rem; position: relative; line-height: 1.5; white-space: pre-wrap; }
        .message.error { border: 2px solid #ff4444 !important; background-color: #ffe6e6 !important; color: #cc0000 !important; box-shadow: 6px 6px 0 0 #550000 !important; }
        .message b, .message strong { color: white; background: var(--accent-pink); font-weight: 900; padding: 0 4px; box-shadow: 2px 2px 0 black; transform: rotate(-1deg); display: inline-block; }
        .message i, .message em { font-family: 'VT323', monospace; font-size: 1.2rem; color: var(--accent-purple); background: rgba(0,0,0,0.05); padding: 0 5px; border-bottom: 2px solid var(--accent-purple); font-style: normal; }
        
        .message.bot { align-self: flex-start; background: #ffffff; box-shadow: 6px 6px 0 0 black; border-radius: 0; margin-left: 50px; border-left: 10px solid black; }
        .bot-icon { position: absolute; top: -50px; left: -60px; width: 80px; height: 80px; object-fit: contain; image-rendering: pixelated; filter: drop-shadow(5px 5px 0 black); z-index: 10; transition: transform 0.1s; }
        .bot-icon:hover { transform: scale(1.2) rotate(10deg); }
        
        .message.user { align-self: flex-end; background: black; color: var(--bg-color); box-shadow: -6px 6px 0 0 var(--accent-green); border-radius: 0; border: 3px solid var(--bg-color); }
        .message.user b { background: var(--bg-color); color: black; box-shadow: 2px 2px 0 white; }
        
        .input-area { border-top: var(--border-black); padding: 15px; background: var(--bg-color); display: flex; gap: 10px; }
        input { flex: 1; border: var(--border-black); padding: 15px; font-family: 'Space Mono'; font-weight: bold; outline: none; font-size: 1rem; background: white; }
        input:focus { background: #fffbe6; box-shadow: inset 4px 4px 0 rgba(0,0,0,0.1); }
        button#send-btn { background: var(--accent-green); border: var(--border-black); padding: 0 30px; font-family: 'Archivo Black'; cursor: pointer; box-shadow: 5px 5px 0 0 black; font-size: 1.1rem; text-transform: uppercase; letter-spacing: 1px; transition: all 0.1s; display: flex; justify-content: center; align-items: center; }
        button#send-btn.fuck-mode { background-color: black !important; border-color: var(--accent-pink) !important; transform: scale(0.95); box-shadow: inset 0px 0px 10px var(--accent-pink); pointer-events: none; }
        .dedo-icon { height: 30px; width: auto; filter: drop-shadow(0 0 5px var(--accent-pink)); animation: pop-up 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
        @keyframes pop-up { 0% { transform: scale(0) rotate(-45deg); } 100% { transform: scale(1) rotate(0deg); } }
        button#send-btn:active { transform: translate(4px, 4px); box-shadow: 1px 1px 0 0 black; }
        button#send-btn:hover { background: #4dff73; }
        
        .group-overlay { position: absolute; bottom: 0; right: 20px; height: 350px; width: auto; z-index: 0; pointer-events: none; filter: drop-shadow(8px -8px 0 rgba(0,0,0,1)) contrast(1.2) saturate(1.2); opacity: 0.9; transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); transform: scaleX(-1); }
        .shake-active ~ .group-overlay { transform: translateY(-20px) scale(1.05) scaleX(-1); }

        /* --- DESKTOP HUD --- */
        .system-hud {
            position: fixed; bottom: 20px; left: 20px; width: 300px;
            background: black; border: 3px solid var(--accent-green);
            box-shadow: 8px 8px 0 rgba(0,0,0,0.8); padding: 10px;
            z-index: 1500; font-family: 'VT323', monospace;
            display: flex; flex-direction: column; gap: 8px;
        }
        .hud-row { display: flex; justify-content: space-between; align-items: center; color: var(--accent-green); font-size: 1.1rem; border-bottom: 1px dashed #333; padding-bottom: 4px; }
        .hud-btn { background: var(--accent-green); color: black; border: none; font-family: 'Space Mono', monospace; font-weight: bold; text-transform: uppercase; cursor: pointer; padding: 5px; text-align: center; font-size: 0.9rem; margin-top: 5px; transition: all 0.2s; }
        .hud-btn:hover { background: white; box-shadow: 0 0 10px white; }
        #quota-display.warning { color: #ffcc00; }
        #quota-display.danger { color: #ff4444; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }
        
        /* HIDE HAMBURGER ON DESKTOP */
        .hamburger { display: none; }

        /* --- CHANGELOG MODAL --- */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .modal-overlay.open { display: flex; }
        .modal-box { width: 90%; max-width: 600px; max-height: 80vh; background: var(--bg-color); border: var(--border-black); box-shadow: 15px 15px 0 black; display: flex; flex-direction: column; animation: pop-up 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .modal-header { background: black; color: white; padding: 15px; font-family: 'Archivo Black'; display: flex; justify-content: space-between; align-items: center; }
        .close-modal { cursor: pointer; color: var(--accent-pink); font-size: 1.5rem; }
        .modal-content { padding: 20px; overflow-y: auto; font-family: 'Space Mono'; font-size: 0.85rem; background: repeating-linear-gradient(0deg, transparent, transparent 19px, #e5e5f7 20px); }
        .log-entry { margin-bottom: 25px; position: relative; }
        .log-entry h3 { background: black; color: var(--accent-green); display: inline-block; padding: 5px 10px; margin: 0 0 10px 0; font-family: 'VT323'; font-size: 1.4rem; transform: rotate(-1deg); box-shadow: 4px 4px 0 rgba(0,0,0,0.2); }
        .log-entry ul { padding-left: 20px; margin: 0; list-style-type: square; }
        .log-entry li { margin-bottom: 5px; line-height: 1.4; }
        .version-tag { position: absolute; right: 0; top: 0; background: var(--accent-pink); color: white; padding: 2px 6px; font-weight: bold; font-size: 0.7rem; transform: rotate(2deg); }

        /* --- MOBILE OPTIMIZATION --- */
        @media (max-width: 768px) {
            /* 1. HIDE DECORATIONS */
            header, .sticker, .group-overlay, .grid-bg, .logo-area { display: none !important; }

            /* 2. LAYOUT FIXES */
            body { height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }
            main { 
                flex: 1; width: 100%; 
                padding: 60px 0 0 0; /* Pushes chat down so HUD doesn't cover it */
                margin: 0; gap: 0; flex-direction: column; 
            }
            
            /* 3. TOP HUD BAR (Fixed Layout) */
            .system-hud {
                position: fixed; top: 0; left: 0; width: 100%; height: 50px;
                background: black; border: none; border-bottom: 3px solid var(--accent-green);
                
                /* FORCE SINGLE ROW */
                display: flex !important; 
                flex-direction: row !important;
                flex-wrap: nowrap !important;
                justify-content: space-between; 
                align-items: center;
                gap: 5px;
                
                padding: 0 10px; z-index: 10000;
                box-shadow: none;
            }

            /* Make Hamburger Visible on Mobile & Fixed Size */
            .hamburger { 
                display: flex !important; 
                width: 35px; height: 35px; 
                align-items: center; justify-content: center;
                margin: 0; flex-shrink: 0;
                border: 1px solid var(--accent-green);
            }

            /* Fix Stats Layout */
            .hud-row { 
                border: none; padding: 0; 
                font-size: 0.75rem; 
                display: flex; gap: 3px; color: var(--accent-green);
                white-space: nowrap; 
            }
            .stats-container {
                display: flex; gap: 8px; align-items: center;
                overflow: hidden; text-overflow: ellipsis;
            }

            /* Fix Logs Button */
            .hud-btn { 
                margin: 0; padding: 4px 8px; font-size: 0.8rem; 
                white-space: nowrap; flex-shrink: 0;
            }

            /* 4. SLIDE-OUT SIDEBAR */
            .sidebar {
                display: flex !important; flex-direction: column;
                position: fixed; top: 50px; left: 0; bottom: 0;
                width: 85%; max-width: 300px;
                background: white; border-right: 3px solid black;
                box-shadow: none; transform: translateX(-100%);
                transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
                z-index: 9999; padding: 0;
            }
            .sidebar.open { transform: translateX(0); box-shadow: 0 0 0 1000px rgba(0,0,0,0.7); }

            .history-panel { display: flex; flex: 1; border: none; } 
            .history-list { padding: 10px; }
            .new-chat-btn { padding: 15px; font-size: 1rem; }

            /* 5. CHAT TWEAKS */
            .chat-interface { width: 100%; height: 100%; border: none; box-shadow: none; display: flex; flex-direction: column; }
            .chat-header { flex-shrink: 0; padding: 10px; font-size: 0.9rem; }
            .messages-area { padding: 20px 15px; gap: 20px; background-size: 10px 10px; }
            .message { max-width: 90%; font-size: 0.95rem; padding: 12px; }
            .message.bot { margin-left: 10px; border-left-width: 5px; }
            .bot-icon { width: 40px; height: 40px; top: -25px; left: -10px; }
            .input-area { padding: 10px; background: var(--bg-color); border-top: 3px solid black; flex-shrink: 0; z-index: 100; }
            .modal-box { width: 95%; max-height: 85vh; }
        }
    </style>
</head>
<body class="crt">
    <div class="grid-bg"></div>
    <img src="grupo.png" class="group-overlay" alt="Jogandofoddaci Crew">
    <div class="sticker" style="top: 20%; left: 5%;">FODDACI</div>
    <div class="sticker" style="bottom: 15%; right: 5%; color: var(--accent-pink); transform: rotate(10deg);">PIMBA</div>

    <header>
        <div class="marquee">/// FODDACITRON V.2.2 /// SISTEMA DE COTA ATIVO /// HASHED IP SECURE ///</div>
    </header>

    <div class="system-hud">
        <div class="hud-btn hamburger" onclick="toggleMobileMenu()">[‚â°]</div>

        <div class="stats-container">
            <div class="hud-row">
                <span>NET:</span><span id="connection-status">...</span>
            </div>
            <div class="hud-row">
                <span>| COTA:</span><span id="quota-display">--/--</span>
            </div>
        </div>
        
        <div class="hud-btn" onclick="toggleModal(true)">LOGS</div>
    </div>

    <main id="main-container">
        <aside class="sidebar" id="mobile-sidebar">
            <div class="logo-area">
                <img src="logo.png" class="channel-logo" alt="Logo" onclick="playSound('pimba')">
            </div>

            <div class="history-panel">
                <div class="history-header">
                    <span>SAVE FILES</span>
                    <span>‚ñº</span>
                </div>
                <div class="history-list" id="history-list-dom"></div>
                <div class="new-chat-btn" onclick="startNewSession()">+ RESET RUN</div>
            </div>
        </aside>

        <section class="chat-interface">
            <div class="chat-header">
                <span id="header-title">TERMINAL_ONLINE</span>
                <div style="display:flex; gap:5px; align-items: center;">
                    <span style="font-size: 0.7rem;">REC ‚óè</span>
                </div>
            </div>
            <div class="messages-area" id="messages"></div>
            <div class="input-area">
                <input type="text" id="user-input" placeholder="Xingue o bot aqui..." autocomplete="off">
                <button id="send-btn">ENVIAR</button>
            </div>
        </section>
    </main>

    <div class="modal-overlay" id="changelog-modal" onclick="if(event.target === this) toggleModal(false)">
        <div class="modal-box">
            <div class="modal-header">
                <span>/// KERNEL_UPDATES ///</span>
                <span class="close-modal" onclick="toggleModal(false)">[X]</span>
            </div>
            <div class="modal-content">

                <div class="log-entry">
                    <h3>DUAL_BRAIN_ARCH</h3>
                    <span class="version-tag">LATEST</span>
                    <ul>
                        <li><b>[IA]</b> DeepSeek-V3.2 integrado como "Roteador" (Decide Busca vs. Chat).</li>
                        <li><b>[DB]</b> Download autom√°tico dos bancos Chroma via Hugging Face.</li>
                        <li><b>[FIX]</b> Permiss√µes de escrita Docker (chmod/chown) corrigidas para usu√°rio n√£o-root.</li>
                    </ul>
                </div>
                
                <div class="log-entry">
                    <h3>SECURITY_PATCH</h3>
                    <span class="version-tag">V2.0</span>
                    <ul>
                        <li><b>[REDE]</b> Implementado Rate Limiting por IP (5 req/min) via SlowAPI.</li>
                        <li><b>[COTA]</b> Sistema de Cota Di√°ria ativado (10 msgs/dia) para evitar abuso.</li>
                        <li><b>[PRIVACIDADE]</b> Hashing de IP (SHA256) implementado para anonimato do usu√°rio.</li>
                        <li><b>[INTERFACE]</b> Nova Barra de Status HUD & Visualiza√ß√£o de Erro 429.</li>
                    </ul>
                </div>

                <div class="log-entry">
                    <h3>CORTEX_MEMORY_UPGRADE</h3>
                    <span class="version-tag">V1.0</span>
                    <ul>
                        <li><b>[MEM]</b> Mem√≥ria de conversa√ß√£o de curto prazo instalada (Janela Deslizante: 6 msgs).</li>
                        <li><b>[RLHF]</b> Inibidor de Alucina√ß√£o ativado (Threshold de similaridade < 1.45).</li>
                        <li><b>[CORE]</b> Prompt do DeepSeek refatorado para incluir contexto hist√≥rico.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = "https://ricsrdocasro-foddacitronbackend.hf.space";
        const ASSETS = { idle: 'foddaci-idle.png', open: 'foddaci-open.png' };
        
        const LOADING_PHRASES = [
            "FRITANDO O C√âREBRO...", "CONSULTANDO A WIKI DO JEAN...", "INVOCANDO O FLAMINGRA√áADO...",
            "PROCESSANDO A HIPOCRISIA...", "CARREGANDO A LEITADA...", "DANDO O CU PRO VITO (L√Å ELE)...",
            "PERGUNTANDO PRO DAVAJONAS...", "METENDO NO LE CUSCUZ...", "BURRINHO DO JEAN T√Å ANALISANDO..."
        ];

        const PLACEHOLDERS = [
            "Quem √© o Big Lig Smoke?", "O Jean √© noob?", "Conte sobre o Scissorman...",
            "Me xinga seu lixo...", "O que aconteceu em Clock Tower?", "Fale sobre o Vito...",
            "Qual a melhor s√©rie?", "Me conte uma piada do Jean...", "Segredo do Flamingra√ßado?"
        ];

        const EL = {
            input: document.getElementById('user-input'),
            btn: document.getElementById('send-btn'),
            msgs: document.getElementById('messages'),
            histList: document.getElementById('history-list-dom'),
            headerTitle: document.getElementById('header-title'),
            main: document.getElementById('main-container'),
            quota: document.getElementById('quota-display'),
            status: document.getElementById('connection-status')
        };

        // --- HUD MANAGER ---
        async function fetchServerUsage() {
            try {
                const response = await fetch(`${API_URL}/usage`);
                if (response.ok) {
                    const data = await response.json();
                    updateUsageVisuals(data.count, data.limit);
                }
            } catch (error) {
                console.error("Erro ao buscar cota:", error);
                EL.quota.innerText = "ERR";
                EL.status.innerText = "üî¥";
            }
        }

        function updateUsageVisuals(count, limit) {
            EL.quota.innerText = `${count}/${limit}`;
            EL.quota.className = ""; 
            EL.status.innerText = "üü¢";

            if (count >= limit) {
                EL.quota.classList.add('danger');
                EL.status.innerText = "‚õî";
            } else if (count >= limit * 0.8) {
                EL.quota.classList.add('warning');
            }
        }
        fetchServerUsage();
        setInterval(fetchServerUsage, 10000);

        // --- SESSION MANAGEMENT ---
        let storageData = JSON.parse(localStorage.getItem('foddaci_data')) || { currentId: Date.now(), sessions: {} };
        if (!storageData.sessions[storageData.currentId]) storageData.sessions[storageData.currentId] = [{ sender: 'bot', text: 'FoddaciTron Online üçºüçº' }];
        
        let currentSession = storageData.sessions[storageData.currentId];
        let activeTyperId = 0; let charQueue = []; let isProcessingQueue = false; let isBold = false; let isItalic = false;

        renderHistoryList(); loadCurrentSession(); rotatePlaceholder();

        function saveStorage() { localStorage.setItem('foddaci_data', JSON.stringify(storageData)); }
        
        function deleteSession(id) {
            if(!confirm("TEM CERTEZA QUE QUER DELETAR ESSE CHAT?")) return;
            delete storageData.sessions[id];
            if (id === storageData.currentId) {
                const remainingIds = Object.keys(storageData.sessions);
                if (remainingIds.length > 0) switchToSession(parseInt(remainingIds[remainingIds.length - 1]));
                else startNewSession();
            } else { saveStorage(); renderHistoryList(); }
        }

        function playSound(type) { console.log("Sound: " + type); }
        function triggerShake() { EL.main.classList.add('shake-active'); setTimeout(() => EL.main.classList.remove('shake-active'), 500); }
        function rotatePlaceholder() { let i = 0; setInterval(() => { i = (i + 1) % PLACEHOLDERS.length; EL.input.setAttribute('placeholder', PLACEHOLDERS[i]); }, 3000); }
        function applyMarkdown(text) { return text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\*(.*?)\*/g, '<i>$1</i>'); }

        function startNewSession() {
            const newId = Date.now(); storageData.currentId = newId;
            storageData.sessions[newId] = [{ sender: 'bot', text: 'Nova run. Sem save state.' }];
            saveStorage(); currentSession = storageData.sessions[newId]; renderHistoryList(); loadCurrentSession(); playSound('reset');
            // Close mobile menu if open
            if (window.innerWidth <= 768) {
                const sidebar = document.getElementById('mobile-sidebar');
                if(sidebar) sidebar.classList.remove('open');
            }
        }

        function switchToSession(id) { 
            storageData.currentId = id; currentSession = storageData.sessions[id]; saveStorage(); renderHistoryList(); loadCurrentSession(); 
            // Close mobile menu if open
            if (window.innerWidth <= 768) {
                const sidebar = document.getElementById('mobile-sidebar');
                if(sidebar) sidebar.classList.remove('open');
            }
        }

        function loadCurrentSession() {
            EL.msgs.innerHTML = ''; currentSession.forEach(msg => renderMessageHTML(msg.text, msg.sender));
            setTimeout(() => EL.msgs.scrollTop = EL.msgs.scrollHeight, 100); EL.headerTitle.innerText = "RUN_ID_" + storageData.currentId.toString().slice(-4);
        }

        function renderHistoryList() {
            EL.histList.innerHTML = ''; const ids = Object.keys(storageData.sessions).reverse();
            ids.forEach(id => {
                const session = storageData.sessions[id]; const firstUserMsg = session.find(m => m.sender === 'user'); const title = firstUserMsg ? firstUserMsg.text : "Intro";
                const div = document.createElement('div'); div.classList.add('history-item'); if (parseInt(id) === storageData.currentId) div.classList.add('active');
                const spanText = document.createElement('span'); spanText.className = 'history-text'; spanText.innerText = title;
                const spanDelete = document.createElement('span'); spanDelete.className = 'delete-btn'; spanDelete.innerText = '[X]'; spanDelete.title = 'Deletar essa desgra√ßa';
                div.onclick = () => switchToSession(parseInt(id)); spanDelete.onclick = (e) => { e.stopPropagation(); deleteSession(parseInt(id)); };
                div.appendChild(spanText); div.appendChild(spanDelete); EL.histList.appendChild(div);
            });
        }
        function saveToCurrentSession(text, sender) { currentSession.push({ sender, text }); saveStorage(); renderHistoryList(); }

        function renderMessageHTML(text, sender) {
            const div = document.createElement('div'); div.classList.add('message', sender);
            let botImg = null;
            if (sender === 'bot') { botImg = document.createElement('img'); botImg.src = ASSETS.idle; botImg.classList.add('bot-icon'); div.appendChild(botImg); }
            const textSpan = document.createElement('span'); textSpan.innerHTML = applyMarkdown(text); div.appendChild(textSpan);
            EL.msgs.appendChild(div); EL.msgs.scrollTop = EL.msgs.scrollHeight; return { div, botImg, textSpan };
        }

        let talkInterval = null; let isMouthOpen = false; let currentAnimatingImg = null; 
        function startTalkingAnimation(imgElement) { if (talkInterval) return; currentAnimatingImg = imgElement; talkInterval = setInterval(() => { if(!currentAnimatingImg) return; isMouthOpen = !isMouthOpen; currentAnimatingImg.src = isMouthOpen ? ASSETS.open : ASSETS.idle; }, 80); }
        function stopTalkingAnimation() { if (talkInterval) { clearInterval(talkInterval); talkInterval = null; } if (currentAnimatingImg) { currentAnimatingImg.src = ASSETS.idle; currentAnimatingImg = null; } }

        function processCharQueue(targetSpan, targetImg, fullTextBuffer, typerId) {
            if (typerId !== activeTyperId) return; 
            if (charQueue.length > 0) {
                isProcessingQueue = true;
                let char = charQueue[0]; let nextChar = charQueue[1];
                if (char === '*' && nextChar === '*') { charQueue.shift(); charQueue.shift(); isBold = !isBold; fullTextBuffer.val += isBold ? "<b>" : "</b>"; processCharQueue(targetSpan, targetImg, fullTextBuffer, typerId); return; }
                if (char === '*' && nextChar !== '*') { charQueue.shift(); isItalic = !isItalic; fullTextBuffer.val += isItalic ? "<i>" : "</i>"; processCharQueue(targetSpan, targetImg, fullTextBuffer, typerId); return; }
                char = charQueue.shift(); startTalkingAnimation(targetImg);
                if (char === '!' && isBold) triggerShake();
                if (char === '\n') fullTextBuffer.val += "<br>"; else fullTextBuffer.val += char;
                targetSpan.innerHTML = fullTextBuffer.val; EL.msgs.scrollTop = EL.msgs.scrollHeight; setTimeout(() => processCharQueue(targetSpan, targetImg, fullTextBuffer, typerId), 15);
            } else { isProcessingQueue = false; stopTalkingAnimation(); if (fullTextBuffer.val.length > 0) { saveToCurrentSession(fullTextBuffer.val, 'bot'); fullTextBuffer.val = ""; } toggleInput(true); }
        }
        function toggleInput(enabled) { EL.input.disabled = !enabled; EL.btn.disabled = !enabled; if(enabled) EL.input.focus(); }

        async function handleSend() {
            const text = EL.input.value; if (!text.trim()) return;
            const originalBtnText = EL.btn.innerText; EL.btn.innerHTML = '<img src="logo.png" class="dedo-icon" alt="üñï">'; EL.btn.classList.add('fuck-mode'); setTimeout(() => { EL.btn.innerHTML = originalBtnText; EL.btn.classList.remove('fuck-mode'); }, 1500);
            isBold = false; isItalic = false; charQueue = []; activeTyperId++; const currentId = activeTyperId;
            toggleInput(false); renderMessageHTML(text, 'user'); saveToCurrentSession(text, 'user'); EL.input.value = ''; playSound('send');
            const uiElements = renderMessageHTML(LOADING_PHRASES[Math.floor(Math.random() * LOADING_PHRASES.length)], 'bot');
            const fullTextBuffer = { val: "" }; let isFirstChunk = true;
            
            const rawHistory = currentSession.slice(0, -1);
            const formattedHistory = rawHistory.map(msg => ({ role: msg.sender === 'bot' ? 'assistant' : 'user', content: msg.text }));

            try {
                const response = await fetch(`${API_URL}/chat`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: text, history: formattedHistory })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    uiElements.textSpan.innerHTML = `‚ö†Ô∏è ${errorData.detail || "Erro no servidor"}`;
                    uiElements.div.classList.add('error'); 
                    stopTalkingAnimation(); toggleInput(true); fetchServerUsage(); return;
                }
                fetchServerUsage();
                const reader = response.body.getReader(); const decoder = new TextDecoder("utf-8");
                while (true) {
                    const { done, value } = await reader.read(); if (done) break;
                    const chunk = decoder.decode(value, { stream: true });
                    if (isFirstChunk && chunk.trim().length > 0) { uiElements.textSpan.innerHTML = ""; isFirstChunk = false; }
                    for (let char of chunk) charQueue.push(char);
                    if (!isProcessingQueue) processCharQueue(uiElements.textSpan, uiElements.botImg, fullTextBuffer, currentId);
                }
            } catch (error) { console.error(error); uiElements.textSpan.innerText = "[ERRO: O VITO TROPE√áOU NO SERVIDOR]"; stopTalkingAnimation(); toggleInput(true); }
        }

        // --- MODAL CONTROL ---
        function toggleModal(show) {
            const modal = document.getElementById('changelog-modal');
            if (show) {
                modal.classList.add('open');
                playSound('pimba'); 
            } else {
                modal.classList.remove('open');
            }
        }
        
        // --- MOBILE MENU ---
        function toggleMobileMenu() {
            const sidebar = document.getElementById('mobile-sidebar');
            if(sidebar) {
                sidebar.classList.toggle('open');
                playSound('pimba');
            }
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === "Escape") toggleModal(false);
        });

        EL.btn.addEventListener('click', handleSend); EL.input.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleSend(); });
    </script>
</body>
</html>